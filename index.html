<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rod Filter</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
#filters { display: flex; flex-wrap: wrap; gap: 20px; max-width: 1000px; }
.filter-column { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 200px; }
label { font-weight: bold; }
select { width: 100%; padding: 5px; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; table-layout: fixed; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
th { background-color: #f2f2f2; }
#loading { width: 100%; background-color: #eee; margin-bottom: 10px; display: none; }
#loadingBar { width: 0%; height: 20px; background-color: #4CAF50; text-align: center; color: white; line-height: 20px; }
</style>
</head>
<body>
<h2>Fishing Rod Filter</h2>

<div id="loading">
  <div id="loadingBar">Loading...</div>
</div>

<div id="filters">
  <div class="filter-column">
    <label>Brand:</label><select id="filterBrand"><option value="">All</option></select>
    <label>Type:</label><select id="filterType"><option value="">All</option></select>
    <label>Reel Type:</label><select id="filterReelType"><option value="">All</option></select>
    <label>Length:</label><select id="filterLength"><option value="">All</option></select>
    <label>Joint Type:</label><select id="filterJointType"><option value="">All</option></select>
    <label>Power:</label><select id="filterPower"><option value="">All</option></select>
  </div>
  <div class="filter-column">
    <label>Action:</label><select id="filterAction"><option value="">All</option></select>
    <label>Material:</label><select id="filterMaterial"><option value="">All</option></select>
    <label>Ring:</label><select id="filterRing"><option value="">All</option></select>
    <label>Reel Seat:</label><select id="filterReelSeat"><option value="">All</option></select>
    <label>Warranty:</label><select id="filterWarranty"><option value="">All</option></select>
  </div>
</div>

<table id="rodTable">
  <thead>
    <tr id="tableHeader"></tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
const sheetCSV = "https://raw.githubusercontent.com/MeefahOnline/Rod-Database/refs/heads/main/Rod%20CSV.csv";

// Show loading
const loading = document.getElementById("loading");
const loadingBar = document.getElementById("loadingBar");
loading.style.display = "block";
loadingBar.style.width = "0%";

fetch(sheetCSV)
  .then(res => {
    const reader = res.body.getReader();
    const contentLength = +res.headers.get('Content-Length');
    let receivedLength = 0;
    let chunks = [];

    return reader.read().then(function processResult(result){
      if(result.done) return new TextDecoder("utf-8").decode(new Uint8Array(chunks.flat()));
      chunks.push(result.value);
      receivedLength += result.value.length;
      if(contentLength) loadingBar.style.width = Math.floor((receivedLength/contentLength)*100)+"%";
      return reader.read().then(processResult);
    });
  })
  .then(text => {
    loadingBar.style.width = "100%";
    loading.style.display = "none";

    const rows = text.trim().split("\n").filter(r => r);
    const headers = rows[0].split(",");

    const tableHeader = document.getElementById("tableHeader");
    tableHeader.innerHTML = headers.map(h => "<th>"+h+"</th>").join("");

    const tableBody = document.getElementById("tableBody");
    const tableData = rows.slice(1).map(r => r.split(",").map(c => c.replace(/^;|;$/g,""))); // remove semicolons

    const filters = {
      Brand: new Set(),
      Type: new Set(),
      "Reel Type": new Set(),
      Length: new Set(),
      "Joint Type": new Set(),
      Power: new Set(),
      Action: new Set(),
      Material: new Set(),
      Ring: new Set(),
      "Reel Seat": new Set(),
      Warranty: new Set()
    };

    tableData.forEach(row => {
      filters.Brand.add(row[1] || "");
      filters.Type.add(row[3] || "");
      filters["Reel Type"].add(row[4] || "");
      filters.Length.add(row[5] || "");
      filters["Joint Type"].add(row[6] || "");
      filters.Power.add(row[8] || "");
      filters.Action.add(row[10] || "");
      filters.Material.add(row[11] || "");
      filters.Ring.add(row[12] || "");
      filters["Reel Seat"].add(row[13] || "");
      filters.Warranty.add(row[18] || "");
    });

    function populateSelect(id, set) {
      const select = document.getElementById(id);
      Array.from(set).sort().forEach(val => {
        if(val) select.innerHTML += `<option value="${val}">${val}</option>`;
      });
    }

    populateSelect("filterBrand", filters.Brand);
    populateSelect("filterType", filters.Type);
    populateSelect("filterReelType", filters["Reel Type"]);
    populateSelect("filterLength", filters.Length);
    populateSelect("filterJointType", filters["Joint Type"]);
    populateSelect("filterPower", filters.Power);
    populateSelect("filterAction", filters.Action);
    populateSelect("filterMaterial", filters.Material);
    populateSelect("filterRing", filters.Ring);
    populateSelect("filterReelSeat", filters["Reel Seat"]);
    populateSelect("filterWarranty", filters.Warranty);

    function renderTable() {
      const vals = {
        Brand: document.getElementById("filterBrand").value,
        Type: document.getElementById("filterType").value,
        "Reel Type": document.getElementById("filterReelType").value,
        Length: document.getElementById("filterLength").value,
        "Joint Type": document.getElementById("filterJointType").value,
        Power: document.getElementById("filterPower").value,
        Action: document.getElementById("filterAction").value,
        Material: document.getElementById("filterMaterial").value,
        Ring: document.getElementById("filterRing").value,
        "Reel Seat": document.getElementById("filterReelSeat").value,
        Warranty: document.getElementById("filterWarranty").value
      };

      tableBody.innerHTML = "";
      tableData.forEach(row => {
        if(
          (!vals.Brand || row[1]===vals.Brand) &&
          (!vals.Type || row[3]===vals.Type) &&
          (!vals["Reel Type"] || row[4]===vals["Reel Type"]) &&
          (!vals.Length || row[5]===vals.Length) &&
          (!vals["Joint Type"] || row[6]===vals["Joint Type"]) &&
          (!vals.Power || row[8]===vals.Power) &&
          (!vals.Action || row[10]===vals.Action) &&
          (!vals.Material || row[11]===vals.Material) &&
          (!vals.Ring || row[12]===vals.Ring) &&
          (!vals["Reel Seat"] || row[13]===vals["Reel Seat"]) &&
          (!vals.Warranty || row[18]===vals.Warranty)
        ) {
          tableBody.innerHTML += "<tr>"+row.map(c => "<td>"+c+"</td>").join("")+"</tr>";
        }
      });
    }

    Object.keys(filters).forEach(f => {
      document.getElementById("filter"+f.replace(/ /g,"")).addEventListener("change", renderTable);
    });

    renderTable();

  })
  .catch(err => {
    console.error("Failed to load CSV:", err);
    loadingBar.style.backgroundColor = "red";
    loadingBar.textContent = "Failed to load database!";
  });
</script>
</body>
</html>
